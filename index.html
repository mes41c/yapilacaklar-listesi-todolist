<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YapÄ±lacaklar Listesi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase SDK'larÄ±nÄ± iÃ§e aktar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut as firebaseSignOut,
            signInWithCustomToken,
            GoogleAuthProvider, 
            signInWithPopup     
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            serverTimestamp, 
            updateDoc, 
            orderBy, 
            writeBatch, 
            getDocs, 
            where,
            limit,
            setDoc,
            getDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCCML1QJZWGQbIHFtr7iohPzT11E5RBONo",
          authDomain: "yapilacaklarlistesi-aa004.firebaseapp.com",
          projectId: "yapilacaklarlistesi-aa004",
          storageBucket: "yapilacaklarlistesi-aa004.firebasestorage.app",
          messagingSenderId: "582402705694",
          appId: "1:582402705694:web:3eb74e683ada3e8d56e10f"
        };

        // Uygulama KimliÄŸi (GeliÅŸtirme OrtamÄ± iÃ§in VarsayÄ±lan)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'todo-app-rebuild-final-v3'; // Benzersiz bir ID kullanÄ±n

        // Firebase uygulamasÄ±nÄ± baÅŸlat
        const app = initializeApp(firebaseConfig);
        console.log("Firebase App Initialized:", app.name); 

        let db, authInstance; 

        // Firestore ve Auth servislerini baÅŸlatma
        try {
            db = getFirestore(app);
            console.log("Firestore DB Initialized"); 
        } catch (e) {
            console.error("Firestore baÅŸlatÄ±lÄ±rken hata oluÅŸtu:", e);
            showAppErrorModal("Firestore baÅŸlatÄ±lamadÄ±. LÃ¼tfen Firebase ayarlarÄ±nÄ±zÄ± ve Firestore veritabanÄ± kurulumunuzu kontrol edin.");
        }

        try {
            authInstance = getAuth(app); 
            console.log("Firebase Auth Initialized");
        } catch (e) {
            console.error("Firebase Auth baÅŸlatÄ±lÄ±rken hata oluÅŸtu:", e);
            showAppErrorModal("Kimlik doÄŸrulama servisi baÅŸlatÄ±lamadÄ±.");
        }
        
        // Global deÄŸiÅŸkenler
        let userId = null;
        let todosCollectionRef = null;
        let listsCollectionRef = null;
        let unsubscribeTodos = null;
        let unsubscribeLists = null;
        
        let localTasksCache = []; // GÃ¶revler iÃ§in yerel Ã¶nbellek
        let localListsCache = []; // Listeler iÃ§in yerel Ã¶nbellek
        let activeListId = null;  // Aktif olarak gÃ¶rÃ¼ntÃ¼lenen liste ID'si
        let defaultListTodayId = null; // "BugÃ¼n YapÄ±lacaklar" listesinin ID'si
        let defaultListLaterId = null; // "Daha Sonra YapÄ±lacaklar" listesinin ID'si
        let userProvidedGeminiApiKey = null; // KullanÄ±cÄ±nÄ±n girdiÄŸi Gemini API anahtarÄ±

        // --- UI Elementleri ---
        const authContainer = document.getElementById('authContainer');
        const appMainContainer = document.getElementById('appMainContainer'); 
        const listsPanel = document.getElementById('listsPanel'); 
        const tasksPanel = document.getElementById('tasksPanel'); 
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        const loginButton = document.getElementById('loginButton');
        const signupButton = document.getElementById('signupButton');
        const googleLoginButton = document.getElementById('googleLoginButton'); 
        const switchToSignup = document.getElementById('switchToSignup');
        const switchToLogin = document.getElementById('switchToLogin');
        const logoutButton = document.getElementById('logoutButton');
        const authErrorMessages = document.getElementById('authErrorMessages');
        const taskInput = document.getElementById('taskInput');
        const listSelectorForNewTask = document.getElementById('listSelectorForNewTask');
        const addTaskButton = document.getElementById('addTaskButton');
        const listsContainerEl = document.getElementById('listsContainer'); 
        const addListButton = document.getElementById('addListButton');
        const newListInput = document.getElementById('newListInput');
        const activeListNameHeader = document.getElementById('activeListNameHeader'); 
        const activeTaskList = document.getElementById('activeTaskList');
        const noTasksInListMessage = document.getElementById('noTasksInListMessage');
        const globalNoListsMessage = document.getElementById('globalNoListsMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const authStatusDisplay = document.getElementById('authStatus'); 
        const userIdDisplayElement = document.getElementById('userIdDisplay'); 
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeErrorModalButton = document.getElementById('closeErrorModalButton');
        
        const geminiLoadingModal = document.getElementById('geminiLoadingModal');
        const geminiLoadingModalTitle = document.getElementById('geminiLoadingModalTitle');
        const geminiLoadingModalDescription = document.getElementById('geminiLoadingModalDescription');

        const geminiApiKeyModal = document.getElementById('geminiApiKeyModal');
        const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
        const saveGeminiApiKeyButton = document.getElementById('saveGeminiApiKeyButton');
        const closeGeminiApiKeyModalButton = document.getElementById('closeGeminiApiKeyModalButton');
        const manageApiKeyButton = document.getElementById('manageApiKeyButton'); 
        const hamburgerButton = document.getElementById('hamburgerButton'); // Mobil menÃ¼ butonu
        const sidebarOverlay = document.getElementById('sidebarOverlay'); // Mobil menÃ¼ arkaplanÄ±

        // Genel uygulama hata modalÄ±nÄ± gÃ¶sterme fonksiyonu
        function showAppErrorModal(message) {
            if(errorMessage) errorMessage.textContent = message;
            if(errorModal) errorModal.classList.remove('hidden');
        }
        // Hata modalÄ±nÄ± kapatma olayÄ±
        if(closeErrorModalButton) closeErrorModalButton.addEventListener('click', () => errorModal.classList.add('hidden'));

        // Kimlik doÄŸrulama hatalarÄ±nÄ± gÃ¶sterme fonksiyonu
        function showAuthError(message) {
            if(authErrorMessages) {
                authErrorMessages.textContent = message;
                authErrorMessages.classList.remove('hidden');
            }
        }
        // Kimlik doÄŸrulama hatalarÄ±nÄ± temizleme fonksiyonu
        function clearAuthError() {
            if(authErrorMessages) {
                authErrorMessages.textContent = '';
                authErrorMessages.classList.add('hidden');
            }
        }
        
        // --- Gemini API AnahtarÄ± YÃ¶netimi ---
        // KullanÄ±cÄ±nÄ±n Firestore'a kaydedilmiÅŸ Gemini API anahtarÄ±nÄ± yÃ¼kler
        async function loadUserGeminiApiKey() {
            if (!userId || !db) return null;
            const apiKeyDocRef = doc(db, "artifacts", appId, "users", userId, "settings", "apiKeys");
            try {
                const docSnap = await getDoc(apiKeyDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.gemini && data.gemini.trim() !== "") {
                        console.log("KullanÄ±cÄ±nÄ±n kayÄ±tlÄ± Gemini API anahtarÄ± bulundu.");
                        userProvidedGeminiApiKey = data.gemini; 
                        return data.gemini;
                    }
                }
                console.log("KullanÄ±cÄ± iÃ§in kayÄ±tlÄ± Gemini API anahtarÄ± bulunamadÄ± veya boÅŸ.");
                userProvidedGeminiApiKey = null; 
                return null;
            } catch (error) {
                console.error("Gemini API anahtarÄ± okunurken hata:", error);
                showAppErrorModal("API anahtarÄ± okunurken bir sorun oluÅŸtu.");
                userProvidedGeminiApiKey = null;
                return null;
            }
        }

        // KullanÄ±cÄ±nÄ±n girdiÄŸi Gemini API anahtarÄ±nÄ± Firestore'a kaydeder
        async function saveUserGeminiApiKey() {
            if (!userId || !db || !geminiApiKeyInput) return;
            const apiKeyToSave = geminiApiKeyInput.value.trim();
            if (!apiKeyToSave) {
                showAppErrorModal("API anahtarÄ± boÅŸ olamaz.");
                geminiApiKeyInput.focus();
                geminiApiKeyInput.classList.add('border-red-500');
                return;
            }
            geminiApiKeyInput.classList.remove('border-red-500');
            
            if (saveGeminiApiKeyButton) {
                saveGeminiApiKeyButton.disabled = true;
                saveGeminiApiKeyButton.textContent = "Kaydediliyor...";
            }

            const apiKeyDocRef = doc(db, "artifacts", appId, "users", userId, "settings", "apiKeys");
            try {
                await setDoc(apiKeyDocRef, { gemini: apiKeyToSave }, { merge: true }); 
                userProvidedGeminiApiKey = apiKeyToSave; 
                console.log("Gemini API anahtarÄ± baÅŸarÄ±yla kaydedildi.");
                if(geminiApiKeyModal) geminiApiKeyModal.classList.add('hidden');
            } catch (error) {
                console.error("Gemini API anahtarÄ± kaydedilirken hata:", error);
                showAppErrorModal("API anahtarÄ± kaydedilirken bir sorun oluÅŸtu.");
            } finally {
                if (saveGeminiApiKeyButton) {
                    saveGeminiApiKeyButton.disabled = false;
                    saveGeminiApiKeyButton.textContent = "Kaydet";
                }
            }
        }

        // Gemini API anahtarÄ±nÄ± kontrol eder, yoksa kullanÄ±cÄ±dan ister
        async function checkAndPromptForGeminiApiKey() {
            if (userProvidedGeminiApiKey) {
                console.log("Gemini API anahtarÄ± zaten mevcut (global).");
                if(geminiApiKeyModal) geminiApiKeyModal.classList.add('hidden');
                return true;
            }
            const storedKey = await loadUserGeminiApiKey();
            if (storedKey) {
                if(geminiApiKeyModal) geminiApiKeyModal.classList.add('hidden');
                return true;
            } else {
                console.log("Gemini API anahtarÄ± isteniyor...");
                if(geminiApiKeyModal) {
                    if(geminiApiKeyInput) geminiApiKeyInput.value = ''; 
                    geminiApiKeyModal.classList.remove('hidden');
                }
                return false;
            }
        }

        // Gemini API'sine istek gÃ¶nderir
        async function callGeminiAPI(prompt, loadingTitle = "âœ¨ Gemini dÃ¼ÅŸÃ¼nÃ¼yor...", loadingDescription = "Ä°ÅŸleniyor...") {
            if (!userProvidedGeminiApiKey) {
                const hasKey = await checkAndPromptForGeminiApiKey();
                if (!hasKey) {
                    showAppErrorModal("Gemini Ã¶zelliklerini kullanmak iÃ§in API anahtarÄ±nÄ±zÄ± girmeniz gerekiyor. Sol panelden 'Gemini API AnahtarÄ±nÄ± YÃ¶net' butonuna tÄ±klayarak anahtarÄ±nÄ±zÄ± ekleyebilirsiniz.");
                    return null; 
                }
                 if (!userProvidedGeminiApiKey) {
                     console.warn("Gemini API anahtarÄ± girilmedi veya modal kapatÄ±ldÄ±.");
                     return null;
                 }
            }
            
            const apiKey = userProvidedGeminiApiKey; 

            if (!apiKey || apiKey.trim() === "") {
                 showAppErrorModal("GeÃ§erli bir Gemini API anahtarÄ± bulunamadÄ±. LÃ¼tfen ayarlarÄ±nÄ±zÄ± kontrol edin.");
                 console.error("callGeminiAPI: apiKey boÅŸ veya tanÄ±msÄ±z.");
                 return null;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            if(geminiLoadingModal) {
                if(geminiLoadingModalTitle) geminiLoadingModalTitle.textContent = loadingTitle;
                if(geminiLoadingModalDescription) geminiLoadingModalDescription.textContent = loadingDescription;
                geminiLoadingModal.classList.remove('hidden');
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API YanÄ±t HatasÄ± DetaylarÄ±:", errorData);
                     let userFriendlyMessage = `Gemini API hatasÄ±: ${errorData.error?.message || response.statusText}`;
                    if (response.status === 400 && errorData.error?.message.toLowerCase().includes("api key not valid")) {
                        userFriendlyMessage = "GirdiÄŸiniz Gemini API anahtarÄ± geÃ§ersiz. LÃ¼tfen kontrol edin.";
                        userProvidedGeminiApiKey = null; 
                        checkAndPromptForGeminiApiKey(); 
                    } else if (response.status === 403) {
                         userFriendlyMessage = "Gemini API isteÄŸi yasaklandÄ±. API anahtarÄ±nÄ±zÄ±n doÄŸru yetkilere sahip olduÄŸundan veya faturalandÄ±rmanÄ±n etkin olduÄŸundan emin olun.";
                    } else if (response.status === 429) {
                        userFriendlyMessage = "Gemini API kullanÄ±m kotasÄ± aÅŸÄ±ldÄ±. LÃ¼tfen daha sonra tekrar deneyin veya kotanÄ±zÄ± kontrol edin.";
                    }
                    throw new Error(userFriendlyMessage);
                }
                const result = await response.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API Beklenmedik YanÄ±t YapÄ±sÄ±:", result);
                    throw new Error("Gemini API'den geÃ§erli bir yanÄ±t alÄ±namadÄ±.");
                }
            } catch (error) {
                console.error("callGeminiAPI iÃ§inde hata yakalandÄ±:", error);
                showAppErrorModal(`${error.message}`); 
                return null;
            } finally {
                if(geminiLoadingModal) geminiLoadingModal.classList.add('hidden');
            }
        }
        
        // --- Kimlik DoÄŸrulama FonksiyonlarÄ± ---
        // KullanÄ±cÄ± kaydÄ±
        async function handleSignup(e) {
            e.preventDefault();
            if (!authInstance) { showAuthError("Kimlik doÄŸrulama servisi hazÄ±r deÄŸil."); return; } 
            clearAuthError();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            if (!email || !password) {
                showAuthError("E-posta ve ÅŸifre boÅŸ bÄ±rakÄ±lamaz.");
                return;
            }
            if (password.length < 6) {
                showAuthError("Åifre en az 6 karakter olmalÄ±dÄ±r.");
                return;
            }
            if (signupButton) {
                signupButton.disabled = true;
                signupButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 9.27455 20.9097 6.80375 19.1414 5" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>Kaydolunuyor...`;
            }
            try {
                await createUserWithEmailAndPassword(authInstance, email, password);
            } catch (error) {
                console.error("Signup error:", error.code, error.message);
                if (error.code === 'auth/email-already-in-use') {
                    showAuthError("Bu e-posta adresi zaten kayÄ±tlÄ±. LÃ¼tfen giriÅŸ yapmayÄ± deneyin.");
                } else if (error.code === 'auth/weak-password') {
                    showAuthError("Åifre zayÄ±f. LÃ¼tfen daha gÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in.");
                } else {
                    showAuthError(`KayÄ±t hatasÄ±: ${error.message}`);
                }
            } finally {
                if (signupButton) {
                    signupButton.disabled = false;
                    signupButton.textContent = "Kaydol";
                }
            }
        }

        // KullanÄ±cÄ± giriÅŸi
        async function handleLogin(e) {
            e.preventDefault();
            if (!authInstance) { showAuthError("Kimlik doÄŸrulama servisi hazÄ±r deÄŸil."); return; } 
            clearAuthError();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showAuthError("E-posta ve ÅŸifre boÅŸ bÄ±rakÄ±lamaz.");
                return;
            }
            if (loginButton) {
                loginButton.disabled = true;
                loginButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 9.27455 20.9097 6.80375 19.1414 5" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>GiriÅŸ YapÄ±lÄ±yor...`;
            }
            try {
                await signInWithEmailAndPassword(authInstance, email, password);
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                 if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    showAuthError("GeÃ§ersiz e-posta veya ÅŸifre.");
                } else {
                    showAuthError(`GiriÅŸ hatasÄ±: ${error.message}`);
                }
            } finally {
                if (loginButton) {
                    loginButton.disabled = false;
                    loginButton.textContent = "GiriÅŸ Yap";
                }
            }
        }

        // Google ile giriÅŸ
         async function handleGoogleLogin() {
            if (!authInstance) {
                showAuthError("Kimlik doÄŸrulama servisi hazÄ±r deÄŸil.");
                console.error("Auth instance not available in handleGoogleLogin");
                return;
            }
            clearAuthError();
            const provider = new GoogleAuthProvider();
            const googleLoginBtnInstance = document.getElementById('googleLoginButton');
            if(googleLoginBtnInstance) {
                googleLoginBtnInstance.disabled = true;
                googleLoginBtnInstance.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Google ile GiriÅŸ YapÄ±lÄ±yor...`;
            }
            try {
                console.log("Attempting Google Sign-In...");
                await signInWithPopup(authInstance, provider);
                console.log("Google Sign-In successful (or popup closed). onAuthStateChanged will handle the rest.");
            } catch (error) {
                console.error("Google login error:", error.code, error.message);
                if (error.code === 'auth/popup-closed-by-user') {
                    showAuthError("GiriÅŸ penceresi kapatÄ±ldÄ±.");
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                     showAuthError("Bu e-posta ile farklÄ± bir yÃ¶ntemle daha Ã¶nce giriÅŸ yapÄ±lmÄ±ÅŸ. LÃ¼tfen o yÃ¶ntemle giriÅŸ yapÄ±n.");
                } else if (error.code === 'auth/unauthorized-domain') {
                    showAuthError("Bu domainden Google ile giriÅŸ yapmaya izin verilmiyor. Firebase projenizin yetkili domainlerini kontrol edin.");
                } else {
                    showAuthError(`Google ile giriÅŸ hatasÄ±: ${error.message}`);
                }
            } finally {
                if(googleLoginBtnInstance){
                    googleLoginBtnInstance.disabled = false;
                    googleLoginBtnInstance.innerHTML = `<svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.657-3.356-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l0.001-0.001l6.19,5.238C39.903,38.635,44,31.886,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>Google ile GiriÅŸ Yap`;
                }
            }
        }

        // KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸÄ±
        async function handleLogout() {
            if (!authInstance) { showAppErrorModal("Kimlik doÄŸrulama servisi hazÄ±r deÄŸil."); return; } 
            if (logoutButton) logoutButton.disabled = true;
            try {
                await firebaseSignOut(authInstance);
            } catch (error) {
                console.error("Logout error:", error);
                showAppErrorModal(`Ã‡Ä±kÄ±ÅŸ yaparken hata: ${error.message}`);
            } finally {
                if (logoutButton) logoutButton.disabled = false;
            }
        }
        
        // --- Liste YÃ¶netimi FonksiyonlarÄ± ---
        // KullanÄ±cÄ± iÃ§in varsayÄ±lan listelerin (BugÃ¼n, Daha Sonra) varlÄ±ÄŸÄ±nÄ± kontrol eder, yoksa oluÅŸturur
        async function ensureDefaultListsExist() {
            if (!userId || !db) return;
            const userListsCollectionRef = collection(db, "artifacts", appId, "users", userId, "lists");
            
            const q = query(userListsCollectionRef, limit(1)); // Herhangi bir liste var mÄ± diye kontrol et
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                console.log("KullanÄ±cÄ± iÃ§in liste bulunamadÄ±, varsayÄ±lanlar oluÅŸturuluyor...");
                try {
                    const todayData = { name: "BugÃ¼n YapÄ±lacaklar", order: 1, createdAt: serverTimestamp(), isDeletable: false };
                    const todayRef = await addDoc(userListsCollectionRef, todayData);
                    defaultListTodayId = todayRef.id;
                    
                    const laterData = { name: "Daha Sonra YapÄ±lacaklar", order: 2, createdAt: serverTimestamp(), isDeletable: false };
                    const laterRef = await addDoc(userListsCollectionRef, laterData);
                    defaultListLaterId = laterRef.id;
                    
                    console.log("VarsayÄ±lan listeler oluÅŸturuldu:", defaultListTodayId, defaultListLaterId);
                    if (!activeListId) activeListId = defaultListTodayId; // Aktif liste yoksa ilk varsayÄ±lanÄ± ata
                } catch (error) {
                    console.error("VarsayÄ±lan listeler oluÅŸturulurken hata:", error);
                    showAppErrorModal("VarsayÄ±lan listeler oluÅŸturulamadÄ±.");
                }
            } else {
                 console.log("Mevcut listeler bulundu.");
                 if (!activeListId && localListsCache.length > 0) { // Aktif liste yoksa ve Ã¶nbellekte liste varsa ilkini ata
                    const sortedListsForActive = [...localListsCache].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
                    activeListId = sortedListsForActive[0].id;
                 }
            }
        }

        // Yeni bir liste ekler
        async function handleAddNewList() {
            console.log("handleAddNewList: function entered."); 
            if (!userId || !db) {
                console.error("handleAddNewList: userId or db is not available."); 
                showAppErrorModal("GiriÅŸ yapÄ±lmalÄ± veya veritabanÄ± hazÄ±r deÄŸil."); 
                if(addListButton) { 
                    addListButton.disabled = false;
                    addListButton.textContent = "Liste Ekle";
                }
                return;
            }

            if (!newListInput) {
                console.error("handleAddNewList: newListInput element not found.");
                showAppErrorModal("Liste adÄ± giriÅŸ alanÄ± bulunamadÄ±.");
                return;
            }
            const listName = newListInput.value.trim();

            if (!listName) {
                console.warn("handleAddNewList: List name is empty."); 
                showAppErrorModal("Liste adÄ± boÅŸ olamaz.");
                if(addListButton) { 
                    addListButton.disabled = false;
                    addListButton.textContent = "Liste Ekle";
                }
                return;
            }
 
            if (addListButton) {
                addListButton.disabled = true;
                addListButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 9.27455 20.9097 6.80375 19.1414 5" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>Ekleniyor...`;
                console.log("handleAddNewList: addListButton disabled and text changed to 'Ekleniyor...'.");
            } else {
                console.warn("handleAddNewList: addListButton element not found when trying to disable.");
            }

            try {
                console.log("handleAddNewList: Attempting to add list to Firestore.");
                if (!listsCollectionRef) { 
                     listsCollectionRef = collection(db, "artifacts", appId, "users", userId, "lists");
                     console.log("handleAddNewList: listsCollectionRef re-initialized.");
                }
                // Yeni liste iÃ§in sÄ±ralama deÄŸeri belirle
                const newOrder = localListsCache.length > 0 ? Math.max(...localListsCache.map(l => l.data.order || 0)) + 1 : 1;
                await addDoc(listsCollectionRef, { 
                    name: listName,
                    order: newOrder,
                    createdAt: serverTimestamp(),
                    isDeletable: true // KullanÄ±cÄ±nÄ±n oluÅŸturduÄŸu listeler silinebilir
                });
                console.log("handleAddNewList: List added to Firestore successfully.");
                if(newListInput) newListInput.value = ""; // Input alanÄ±nÄ± temizle
            } catch (error) {
                console.error("handleAddNewList: Error adding new list to Firestore:", error);
                showAppErrorModal("Yeni liste eklenemedi: " + error.message);
            } finally {
                console.log("handleAddNewList: finally block reached.");
                if (addListButton) { 
                    addListButton.disabled = false;
                    addListButton.textContent = "Liste Ekle";
                    console.log("handleAddNewList: addListButton re-enabled and text reset.");
                } else {
                    console.warn("handleAddNewList: addListButton element not found in finally block.");
                }
            }
        }

        // Bir listenin adÄ±nÄ± gÃ¼nceller
        async function updateListName(listId, newName) {
            if (!userId || !db) return false;
            if (!newName.trim()) {
                showAppErrorModal("Liste adÄ± boÅŸ olamaz.");
                return false; 
            }
            const listDocRef = doc(db, "artifacts", appId, "users", userId, "lists", listId);
            try {
                await updateDoc(listDocRef, { name: newName });
                return true; 
            } catch (error) {
                console.error("Liste adÄ± gÃ¼ncellenirken hata:", error);
                showAppErrorModal(`Liste adÄ± gÃ¼ncellenemedi: ${error.message}`);
                return false; 
            }
        }
        
        // Bir listeyi ve iÃ§indeki tÃ¼m gÃ¶revleri siler
        async function deleteUserList(listId) {
            if (!userId || !db) return;
            const listToDelete = localListsCache.find(l => l.id === listId);
            if (!listToDelete || listToDelete.data.isDeletable === false) { // VarsayÄ±lan listeler silinemez
                 showAppErrorModal("Bu liste silinemez.");
                 return;
            }
            
            const userTodosCollectionRef = collection(db, "artifacts", appId, "users", userId, "todos");
            const userListsCollectionRef = collection(db, "artifacts", appId, "users", userId, "lists");

            const batch = writeBatch(db); // Toplu iÅŸlem iÃ§in batch oluÅŸtur
            const tasksInListQuery = query(userTodosCollectionRef, where("listId", "==", listId));
            try {
                // Listeye ait gÃ¶revleri bul ve silme iÅŸlemine ekle
                const tasksSnapshot = await getDocs(tasksInListQuery);
                tasksSnapshot.forEach(taskDoc => {
                    batch.delete(doc(userTodosCollectionRef, taskDoc.id));
                });

                // Listeyi silme iÅŸlemine ekle
                const listDocRef = doc(userListsCollectionRef, listId);
                batch.delete(listDocRef);

                await batch.commit(); // Toplu silme iÅŸlemini gerÃ§ekleÅŸtir
                console.log(`Liste "${listToDelete.data.name}" ve gÃ¶revleri silindi.`);
                if (activeListId === listId) { // Silinen liste aktif listeyse, aktif listeyi sÄ±fÄ±rla
                    activeListId = null; 
                }
            } catch (error) {
                console.error("Liste silinirken hata:", error);
                showAppErrorModal(`Liste silinemedi: ${error.message}`);
            }
        }

        // --- GÃ¶rev YÃ¶netimi FonksiyonlarÄ± ---
        // Firestore'a yeni bir gÃ¶rev (veya alt gÃ¶rev) ekler
        async function addTaskToFirestore(taskText, parentId = null, prefix = "", order = Date.now(), targetListId) {
            const fullTaskText = prefix ? `${prefix} ${taskText}` : taskText;
            if (fullTaskText.trim() === '') return Promise.resolve();  
            if (!userId || !db) { 
                showAppErrorModal('GÃ¶rev eklemek iÃ§in oturum aÃ§Ä±lmalÄ± veya veritabanÄ± hazÄ±r deÄŸil.');
                return Promise.reject("KullanÄ±cÄ± oturumu yok veya db referansÄ± tanÄ±msÄ±z.");
            }
            const currentTodosCollectionRef = collection(db, "artifacts", appId, "users", userId, "todos");

            try {
                const taskData = {
                    text: fullTaskText,
                    completed: false,
                    createdAt: serverTimestamp(),
                    order: order, 
                    parentId: parentId, // Alt gÃ¶revse ana gÃ¶revin ID'si
                    listId: targetListId // GÃ¶revin ait olduÄŸu liste ID'si
                };
                await addDoc(currentTodosCollectionRef, taskData);
                return Promise.resolve();
            } catch (error) {
                showAppErrorModal(`GÃ¶rev Firestore'a eklenirken hata: ${error.message}`);
                return Promise.reject(error);
            }
        }
        
        // Bir sonraki gÃ¶rev iÃ§in sÄ±ralama deÄŸerini hesaplar
        async function getNextOrderValue(parentId = null, targetListId = null) { 
            if (!targetListId && !parentId) { 
                targetListId = activeListId; // Ana gÃ¶rev ekleniyorsa aktif listeyi kullan
            } else if (parentId && !targetListId) { // Alt gÃ¶rev ekleniyorsa ana gÃ¶revin listesini kullan
                const parentTask = localTasksCache.find(t => t.id === parentId);
                targetListId = parentTask?.data.listId;
            }

            if (!targetListId) { 
                console.warn("getNextOrderValue: Hedef listId belirlenemedi.");
                return Date.now(); // Hata durumunda zaman damgasÄ±nÄ± kullan
            }

            let relevantTasks;
            if (parentId) { // Alt gÃ¶revler iÃ§in
                relevantTasks = localTasksCache.filter(t => t.data.parentId === parentId && t.data.listId === targetListId);
            } else { // Ana gÃ¶revler iÃ§in
                relevantTasks = localTasksCache.filter(t => !t.data.parentId && t.data.listId === targetListId);
            }
            if (relevantTasks.length > 0) {
                return Math.max(...relevantTasks.map(t => t.data.order || 0)) + 1;
            }
            return Date.now(); // Ä°lk gÃ¶revse zaman damgasÄ±nÄ± kullan
        }

        // Bir ana gÃ¶revi Gemini API kullanarak alt gÃ¶revlere bÃ¶ler
        async function breakDownTaskIntoSubtasks(originalTaskId, originalTaskText, buttonElement, parentListId) {
            if (!userId) { showAppErrorModal('Oturum aÃ§Ä±lmalÄ±.'); return; }
            if (buttonElement) {
                buttonElement.disabled = true;
                const originalButtonText = buttonElement.innerHTML; 
                buttonElement.innerHTML = `<svg class="animate-spin h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 9.27455 20.9097 6.80375 19.1414 5" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg> ParÃ§alÄ±yor...`;
            }
            const prompt = `Bir yapÄ±lacaklar listesi iÃ§in, ÅŸu ana gÃ¶revi daha kÃ¼Ã§Ã¼k, somut ve yÃ¶netilebilir alt gÃ¶revlere ayÄ±r. Her bir alt gÃ¶revi ayrÄ± bir satÄ±rda listele. Sadece alt gÃ¶revlerin listesini ver:\n\nAna GÃ¶rev: "${originalTaskText}"`;

            try {
                const subtasksText = await callGeminiAPI(prompt, "âœ¨ GÃ¶rev ParÃ§alanÄ±yor", "Gemini alt gÃ¶revleri oluÅŸturuyor...");
                if (subtasksText) {
                    const subtaskList = subtasksText.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                    if (subtaskList.length > 0) {
                        let baseOrder = await getNextOrderValue(originalTaskId, parentListId); 
                        for (let i = 0; i < subtaskList.length; i++) {
                            await addTaskToFirestore(subtaskList[i], originalTaskId, "", baseOrder + i, parentListId); 
                        }
                    } else {
                        showAppErrorModal("Gemini bu gÃ¶rev iÃ§in alt gÃ¶rev oluÅŸturamadÄ±.");
                    }
                }
            } finally {
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = `â†ªï¸ <span class="ml-2">GÃ¶revi ParÃ§ala</span>`; // Buton metnini ve ikonunu geri yÃ¼kle
                }
            }
        }
        
        // Bir gÃ¶revi Gemini API kullanarak detaylandÄ±rÄ±r (notlar, sorular ekler)
        async function elaborateTask(originalTaskId, originalTaskText, buttonElement, parentListId) {
             if (!userId) { showAppErrorModal('Oturum aÃ§Ä±lmalÄ±.'); return; }
            if(buttonElement) {
                buttonElement.disabled = true;
                const originalButtonText = buttonElement.innerHTML;
                buttonElement.innerHTML = `<svg class="animate-spin h-4 w-4 mr-1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 9.27455 20.9097 6.80375 19.1414 5" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg> DetaylÄ±yor...`;
            }
            const prompt = `KullanÄ±cÄ± yapÄ±lacaklar listesine ÅŸunu ekledi: '${originalTaskText}'. Bu gÃ¶revin uygulanmasÄ±na yardÄ±mcÄ± olmak iÃ§in 3-5 adet soru, not veya alt adÄ±m iÃ§eren bir liste oluÅŸtur. Her maddeyi yeni satÄ±rda listele. Sadece listeyi ver:`;

            try {
                const elaboratedText = await callGeminiAPI(prompt, "âœ¨ GÃ¶rev DetaylandÄ±rÄ±lÄ±yor", "Gemini fikirler Ã¼retiyor...");
                if (elaboratedText) {
                    const elaboratedPoints = elaboratedText.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                    if (elaboratedPoints.length > 0) {
                        let baseOrder = await getNextOrderValue(originalTaskId, parentListId); 
                        for (let i = 0; i < elaboratedPoints.length; i++) {
                            await addTaskToFirestore(elaboratedPoints[i], originalTaskId, "ğŸ’¡", baseOrder + i, parentListId); 
                        }
                    } else {
                        showAppErrorModal("Gemini bu gÃ¶rev iÃ§in detay Ã¶nerisi oluÅŸturamadÄ±.");
                    }
                }
            } finally {
                if(buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = `âœ¨ <span class="ml-2">GÃ¶revi DetaylandÄ±r</span>`; // Buton metnini ve ikonunu geri yÃ¼kle
                }
            }
        }

        // KullanÄ±cÄ±nÄ±n girdiÄŸi metinden yeni bir gÃ¶rev ekler
        async function addTaskFromInput() {
            if (!taskInput || !listSelectorForNewTask || !addTaskButton) return; // Gerekli elemanlar yoksa Ã§Ä±k
            const taskText = taskInput.value.trim();
            const selectedListId = listSelectorForNewTask.value; 
            
            if (taskText === '') { 
                showAppErrorModal('GÃ¶rev boÅŸ olamaz!'); 
                return; 
            }
            if (!selectedListId) {
                 showAppErrorModal('LÃ¼tfen bir liste seÃ§in veya yeni bir liste oluÅŸturun.');
                 return;
            }
            if (!userId || !db) { 
                showAppErrorModal('GÃ¶rev eklemek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n veya veritabanÄ± baÄŸlantÄ±sÄ±nÄ± kontrol edin.');
                return;
            }
            
            addTaskButton.disabled = true;
            addTaskButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 9.27455 20.9097 6.80375 19.1414 5" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg> Ekleniyor...`;
            
            try {
                const newOrder = await getNextOrderValue(null, selectedListId);
                await addTaskToFirestore(taskText, null, "", newOrder, selectedListId); 
                taskInput.value = ''; // Input alanÄ±nÄ± temizle
                
                if (activeListId !== selectedListId) { // GÃ¶rev farklÄ± bir listeye eklendiyse o listeyi aktif yap
                    activeListId = selectedListId;
                    renderAppUI(); 
                }
            } catch (error) {
                 console.error("GÃ¶rev ekleme sÄ±rasÄ±nda hata (addTaskFromInput):", error); 
                 showAppErrorModal("GÃ¶rev eklenirken bir sorun oluÅŸtu.");
            }
            finally { 
                addTaskButton.disabled = false;
                addTaskButton.textContent = "Ekle"; 
            }
        }
        
        // Bir gÃ¶revin tamamlanma durumunu deÄŸiÅŸtirir
        async function toggleTaskCompleted(taskId, currentStatus) {
             if (!userId || !db) { showAppErrorModal('Oturum aÃ§Ä±lmalÄ± veya veritabanÄ± hazÄ±r deÄŸil.'); return; }
            const taskDocRef = doc(db, "artifacts", appId, "users", userId, "todos", taskId);
            try { await updateDoc(taskDocRef, { completed: !currentStatus }); }
            catch (error) { showAppErrorModal(`GÃ¶rev gÃ¼ncellenirken hata: ${error.message}`); }
        }

        // Bir gÃ¶revi ve tÃ¼m alt gÃ¶revlerini siler
        async function deleteTask(taskId) {
            if (!userId || !db) { showAppErrorModal('Oturum aÃ§Ä±lmalÄ± veya veritabanÄ± hazÄ±r deÄŸil.'); return; }
            const userTodosCollectionRef = collection(db, "artifacts", appId, "users", userId, "todos");
            const batch = writeBatch(db);
            const tasksToDeleteIds = [taskId]; // BaÅŸlangÄ±Ã§ta ana gÃ¶revi ekle

            // GÃ¶revin tÃ¼m alt gÃ¶revlerini (ve onlarÄ±n alt gÃ¶revlerini) bul
            function findDescendants(currentParentId) {
                const directChildren = localTasksCache.filter(t => t.data.parentId === currentParentId);
                for (const child of directChildren) {
                    tasksToDeleteIds.push(child.id);
                    findDescendants(child.id); // Ã–zyinelemeli olarak devam et
                }
            }
            findDescendants(taskId); // Ana gÃ¶revden baÅŸla

            tasksToDeleteIds.forEach(idToDelete => { // TÃ¼m bulunantasklarÄ± silme iÅŸlemine ekle
                batch.delete(doc(userTodosCollectionRef, idToDelete));
            });
            try { await batch.commit(); } // Toplu sil
            catch (error) { showAppErrorModal(`GÃ¶rev(ler) silinirken hata: ${error.message}`); }
        }
        
        // Bir gÃ¶revin metnini gÃ¼nceller
        async function updateTaskText(taskId, newText) {
            if (!userId || !db) { showAppErrorModal('Oturum aÃ§Ä±lmalÄ± veya veritabanÄ± hazÄ±r deÄŸil.'); return; }
            if (newText.trim() === '') { showAppErrorModal('GÃ¶rev metni boÅŸ olamaz!'); return; }
            const taskDocRef = doc(db, "artifacts", appId, "users", userId, "todos", taskId);
            try { await updateDoc(taskDocRef, { text: newText }); }
            catch (error) { showAppErrorModal(`GÃ¶rev metni gÃ¼ncellenirken hata: ${error.message}`); }
        }

        // Bir gÃ¶revi listede yukarÄ± veya aÅŸaÄŸÄ± taÅŸÄ±r
        async function moveTask(taskId, direction) { 
             if (!userId || !db) { showAppErrorModal('SÄ±ralama iÃ§in oturum aÃ§Ä±lmalÄ±.'); return; }
            const currentTaskDoc = localTasksCache.find(t => t.id === taskId);
            if (!currentTaskDoc) return;
            
            const parentId = currentTaskDoc.data.parentId; // GÃ¶revin ana gÃ¶revi var mÄ±?
            const taskListId = currentTaskDoc.data.listId; // GÃ¶rev hangi listede?
            
            let siblings; // AynÄ± seviyedeki diÄŸer gÃ¶revler (kardeÅŸler)
            if (parentId) { // Alt gÃ¶revse, aynÄ± ana gÃ¶reve baÄŸlÄ± kardeÅŸleri bul
                siblings = localTasksCache.filter(t => t.data.parentId === parentId && t.data.listId === taskListId).sort((a,b) => a.data.order - b.data.order);
            } else { // Ana gÃ¶revse, aynÄ± listedeki diÄŸer ana gÃ¶revleri bul
                siblings = localTasksCache.filter(t => !t.data.parentId && t.data.listId === taskListId).sort((a,b) => a.data.order - b.data.order);
            }
            
            const taskIndex = siblings.findIndex(t => t.id === taskId); // TaÅŸÄ±nacak gÃ¶revin indeksi
            if (taskIndex === -1) return;

            let otherTaskIndex; // Yer deÄŸiÅŸtirilecek diÄŸer gÃ¶revin indeksi
            if (direction === 'up') {
                if (taskIndex === 0) return; // En Ã¼stteyse hareket etme
                otherTaskIndex = taskIndex - 1;
            } else { 
                if (taskIndex === siblings.length - 1) return; // En alttaysa hareket etme
                otherTaskIndex = taskIndex + 1;
            }

            const task1 = siblings[taskIndex]; // TaÅŸÄ±nan gÃ¶rev
            const task2 = siblings[otherTaskIndex]; // Yer deÄŸiÅŸtirilen gÃ¶rev

            // Ä°ki gÃ¶revin order deÄŸerlerini takas et
            const batch = writeBatch(db);
            const task1Ref = doc(db, "artifacts", appId, "users", userId, "todos", task1.id);
            const task2Ref = doc(db, "artifacts", appId, "users", userId, "todos", task2.id);
            batch.update(task1Ref, { order: task2.data.order });
            batch.update(task2Ref, { order: task1.data.order });
            try { await batch.commit(); }
            catch (error) { showAppErrorModal(`GÃ¶revler sÄ±ralanÄ±rken hata: ${error.message}`); }
        }

        // Bir alt gÃ¶revi ana gÃ¶reve dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r
        async function promoteTaskToMain(taskId) { 
            if (!userId || !db) { showAppErrorModal('Oturum aÃ§Ä±lmalÄ±.'); return; }
            const taskToPromote = localTasksCache.find(t => t.id === taskId);
            if (!taskToPromote || !taskToPromote.data.parentId) return; // Ana gÃ¶revi yoksa veya zaten ana gÃ¶revse Ã§Ä±k

            const parentTask = localTasksCache.find(t => t.id === taskToPromote.data.parentId);
            const targetListId = parentTask?.data.listId || activeListId; // Ana gÃ¶revin listesini veya aktif listeyi kullan

            if (!targetListId) {
                 showAppErrorModal("Hedef liste bulunamadÄ±.");
                 return;
            }
            
            const newOrder = await getNextOrderValue(null, targetListId); // Yeni ana gÃ¶revler iÃ§in sÄ±ralama deÄŸeri al

            const taskDocRef = doc(db, "artifacts", appId, "users", userId, "todos", taskId);
            try {
                await updateDoc(taskDocRef, {
                    parentId: null, // Ana gÃ¶rev ID'sini null yap
                    order: newOrder,
                    listId: targetListId // Gerekirse listesini gÃ¼ncelle
                });
            } catch (error) {
                showAppErrorModal(`Alt gÃ¶rev ana gÃ¶reve taÅŸÄ±nÄ±rken hata: ${error.message}`);
            }
        }
        
        // --- UI Render FonksiyonlarÄ± ---
        // Sol paneldeki listeleri render eder
        function renderListsUI() {
            if (!listsContainerEl) return;
            listsContainerEl.innerHTML = ''; // Ã–nceki listeleri temizle
            
            const sortedLists = [...localListsCache].sort((a,b) => (a.data.order || 0) - (b.data.order || 0)); // Listeleri sÄ±rala

            const tasksPanelExists = document.getElementById('tasksPanel'); // SaÄŸ panel var mÄ±?

            // HiÃ§ liste yoksa ilgili mesajlarÄ± ve UI durumlarÄ±nÄ± ayarla
            if (sortedLists.length === 0 && userId) {
                if(globalNoListsMessage) globalNoListsMessage.classList.remove('hidden');
                if(tasksPanelExists) tasksPanelExists.classList.add('hidden'); 
                if(listSelectorForNewTask) listSelectorForNewTask.innerHTML = '<option value="">Liste Yok</option>';
                if(taskInput) taskInput.disabled = true;
                if(addTaskButton) addTaskButton.disabled = true;
                return;
            } else if (userId) { // Listeler varsa UI'Ä± normale dÃ¶ndÃ¼r
                 if(globalNoListsMessage) globalNoListsMessage.classList.add('hidden');
                 if(tasksPanelExists) tasksPanelExists.classList.remove('hidden');
                 if(taskInput) taskInput.disabled = false;
                 if(addTaskButton) addTaskButton.disabled = false;
            }

            // Yeni gÃ¶rev ekleme alanÄ±ndaki liste seÃ§icisini doldur
            if (listSelectorForNewTask) {
                listSelectorForNewTask.innerHTML = '';
                sortedLists.forEach(listDoc => {
                    const option = document.createElement('option');
                    option.value = listDoc.id;
                    option.textContent = listDoc.data.name;
                    if (listDoc.id === activeListId) { // Aktif listeyi seÃ§ili yap
                        option.selected = true;
                    }
                    listSelectorForNewTask.appendChild(option);
                });
            }

            // Her bir listeyi UI'da oluÅŸtur
            sortedLists.forEach(listDoc => {
                const list = listDoc.data;
                const listId = listDoc.id;

                const listItemEl = document.createElement('div');
                listItemEl.className = `list-item group flex items-center justify-between p-2 rounded-md cursor-pointer mb-1 transition-colors ${listId === activeListId ? 'bg-cyan-600 text-white' : 'hover:bg-gray-200 text-gray-700'}`;
                listItemEl.dataset.listId = listId;

                const listNameSpan = document.createElement('span');
                listNameSpan.textContent = list.name;
                listNameSpan.className = "flex-grow truncate list-name-span";
                listItemEl.appendChild(listNameSpan);
                
                const listEditInput = document.createElement('input'); // Liste adÄ± dÃ¼zenleme input'u
                listEditInput.type = 'text';
                listEditInput.value = list.name;
                listEditInput.className = "hidden flex-grow bg-white text-gray-800 border border-cyan-500 rounded px-1 py-0.5 text-sm list-name-input";
                listItemEl.appendChild(listEditInput);


                const actionsDiv = document.createElement('div'); // DÃ¼zenleme ve silme butonlarÄ± iÃ§in container
                actionsDiv.className = "flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity";
                
                const editListButton = document.createElement('button');
                editListButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ${listId === activeListId ? 'text-white/80 hover:text-white' : 'text-gray-500 hover:text-cyan-600'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>`;
                editListButton.title = "Listeyi Yeniden AdlandÄ±r";
                editListButton.className = "p-1 rounded hover:bg-gray-300/50 edit-list-btn";
                editListButton.onclick = (e) => { // Liste dÃ¼zenleme moduna geÃ§
                    e.stopPropagation();
                    listItemEl.classList.add('editing-list');
                    listNameSpan.classList.add('hidden');
                    listEditInput.classList.remove('hidden');
                    listEditInput.focus();
                    listEditInput.select();
                    actionsDiv.classList.add('hidden'); 
                    listItemEl.querySelector('.save-cancel-list-actions')?.classList.remove('hidden');
                };
                actionsDiv.appendChild(editListButton);

                if (list.isDeletable !== false) { // Silinemez olarak iÅŸaretlenmemiÅŸse silme butonu ekle
                    const deleteListBtn = document.createElement('button');
                    deleteListBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ${listId === activeListId ? 'text-red-300 hover:text-red-100' : 'text-red-400 hover:text-red-600'}" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                    deleteListBtn.title = "Listeyi Sil";
                    deleteListBtn.className = "p-1 rounded hover:bg-red-200/50 delete-list-btn";
                    deleteListBtn.onclick = (e) => { e.stopPropagation(); deleteUserList(listId); };
                    actionsDiv.appendChild(deleteListBtn);
                }
                listItemEl.appendChild(actionsDiv);
                
                const saveCancelListActions = document.createElement('div'); // Kaydet/Ä°ptal butonlarÄ± (liste dÃ¼zenleme iÃ§in)
                saveCancelListActions.className = 'save-cancel-list-actions hidden flex items-center space-x-1 ml-2';
                const saveListNameBtn = document.createElement('button');
                saveListNameBtn.textContent = 'âœ“';
                saveListNameBtn.className = `text-xs p-1 rounded ${listId === activeListId ? 'bg-green-200 text-green-800 hover:bg-green-300' : 'bg-green-500 text-white hover:bg-green-600'}`;
                saveListNameBtn.onclick = async (e) => { // Liste adÄ±nÄ± kaydet
                    e.stopPropagation();
                    const success = await updateListName(listId, listEditInput.value);
                    if (success) { // BaÅŸarÄ±lÄ±ysa UI'Ä± gÃ¼ncelle
                         listItemEl.classList.remove('editing-list');
                         listNameSpan.classList.remove('hidden');
                         listEditInput.classList.add('hidden');
                         actionsDiv.classList.remove('hidden');
                         saveCancelListActions.classList.add('hidden');
                    } 
                };
                const cancelListNameBtn = document.createElement('button');
                cancelListNameBtn.textContent = 'âœ•';
                cancelListNameBtn.className = `text-xs p-1 rounded ${listId === activeListId ? 'bg-red-200 text-red-800 hover:bg-red-300' : 'bg-gray-400 text-white hover:bg-gray-500'}`;
                cancelListNameBtn.onclick = (e) => { // DÃ¼zenlemeyi iptal et
                     e.stopPropagation();
                     listEditInput.value = listNameSpan.textContent; 
                     listItemEl.classList.remove('editing-list');
                     listNameSpan.classList.remove('hidden');
                     listEditInput.classList.add('hidden');
                     actionsDiv.classList.remove('hidden');
                     saveCancelListActions.classList.add('hidden');
                };
                saveCancelListActions.appendChild(saveListNameBtn);
                saveCancelListActions.appendChild(cancelListNameBtn);
                listItemEl.appendChild(saveCancelListActions);

                // Listeye tÄ±klandÄ±ÄŸÄ±nda aktif yap ve mobil menÃ¼yÃ¼ kapat
                listItemEl.addEventListener('click', () => {
                    if (listItemEl.classList.contains('editing-list')) return; 
                    activeListId = listId;
                    renderAppUI(); 

                    if (window.innerWidth < 768) {
                        if (listsPanel) {
                            listsPanel.classList.add('-translate-x-full');
                        }
                        if (sidebarOverlay) {
                            sidebarOverlay.classList.add('hidden');
                        }
                    }
                });
                listsContainerEl.appendChild(listItemEl);
            });
        }
        
        // Bir gÃ¶rev dÃ¼ÄŸÃ¼mÃ¼nÃ¼ (ve alt gÃ¶revlerini) UI'da render eder
        function renderTaskNode(taskDoc, level, childrenMap, targetElement) {
            const task = taskDoc.data;
            const taskId = taskDoc.id;
            const parentListId = task.listId; 

            const listItem = document.createElement('li');
            listItem.className = `mb-1 rounded-lg transition-all duration-300 ease-in-out flex flex-col ${task.completed ? 'opacity-60' : ''}`;
            listItem.style.marginLeft = `${level * 18}px`; // Alt gÃ¶revler iÃ§in girinti
            if (level > 0) { // Alt gÃ¶revse sol kenarlÄ±k ekle
                 listItem.classList.add('border-l-2', 'border-gray-300', 'pl-1.5', 'pt-0.5');
            }
            
            const taskWrapper = document.createElement('div'); // GÃ¶rev iÃ§eriÄŸi ve dÃ¼zenleme butonlarÄ± iÃ§in
            listItem.appendChild(taskWrapper);

            const topRow = document.createElement('div'); // Checkbox, metin ve aksiyon butonlarÄ±
            topRow.className = `flex items-center justify-between p-1.5 rounded-md ${task.completed ? 'bg-green-50' : 'bg-white hover:bg-gray-50 shadow-sm'}`;
            
            const leftSection = document.createElement('div'); // Checkbox, metin, sÄ±ralama ve Ã§Ã¶kertme butonlarÄ±
            leftSection.className = 'flex items-center flex-grow min-w-0'; // min-w-0 metin taÅŸmasÄ±nÄ± engeller

            const children = childrenMap.get(taskId) || []; // Bu gÃ¶revin alt gÃ¶revleri
            if (children.length > 0) { // Alt gÃ¶revi varsa Ã§Ã¶kertme/aÃ§ma butonu ekle
                const collapseButton = document.createElement('button');
                collapseButton.className = 'mr-1 p-0.5 rounded hover:bg-gray-200 focus:outline-none';
                taskDoc.isCollapsed = taskDoc.isCollapsed === undefined ? false : taskDoc.isCollapsed; 
                collapseButton.innerHTML = taskDoc.isCollapsed ? 
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>` : // AÃ§Ä±k ikonu
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`; // KapalÄ± ikonu
                
                collapseButton.addEventListener('click', (e) => { // TÄ±klandÄ±ÄŸÄ±nda durumu deÄŸiÅŸtir ve UI'Ä± yeniden render et
                    e.stopPropagation();
                    taskDoc.isCollapsed = !taskDoc.isCollapsed;
                    renderAppUI(); 
                });
                leftSection.appendChild(collapseButton);
            } else if (level === 0) { // En Ã¼st seviyedeki gÃ¶revse ve alt gÃ¶revi yoksa, hizalama iÃ§in boÅŸluk bÄ±rak
                 const spacer = document.createElement('div');
                 spacer.className = 'w-[18px] mr-1'; 
                 leftSection.appendChild(spacer);
            }

            const orderButtons = document.createElement('div'); // YukarÄ±/aÅŸaÄŸÄ± taÅŸÄ±ma butonlarÄ±
            orderButtons.className = 'flex flex-col mr-1 space-y-px';
            
            const parentIdForSiblings = task.parentId || null;
            let siblings;
            if (parentIdForSiblings) {
                siblings = (childrenMap.get(parentIdForSiblings) || []).filter(s => s.data.listId === parentListId).sort((a,b) => a.data.order - b.data.order);
            } else {
                siblings = localTasksCache.filter(t => !t.data.parentId && t.data.listId === parentListId).sort((a,b) => a.data.order - b.data.order);
            }
            const currentIndexInSiblings = siblings.findIndex(s => s.id === taskId);

            const upButton = document.createElement('button');
            upButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-400 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>`;
            upButton.className = 'p-px rounded-sm hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed';
            upButton.disabled = currentIndexInSiblings === 0; // En Ã¼stteyse devre dÄ±ÅŸÄ± bÄ±rak
            upButton.addEventListener('click', (e) => { e.stopPropagation(); moveTask(taskId, 'up'); });
            orderButtons.appendChild(upButton);

            const downButton = document.createElement('button');
            downButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 text-gray-400 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>`;
            downButton.className = 'p-px rounded-sm hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed';
            downButton.disabled = currentIndexInSiblings === siblings.length - 1; // En alttaysa devre dÄ±ÅŸÄ± bÄ±rak
            downButton.addEventListener('click', (e) => { e.stopPropagation(); moveTask(taskId, 'down'); });
            orderButtons.appendChild(downButton);
            leftSection.appendChild(orderButtons);

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = task.completed;
            checkbox.className = 'mr-1.5 h-4 w-4 sm:mr-2 sm:h-4.5 sm:w-4.5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer flex-shrink-0';
            checkbox.addEventListener('change', () => toggleTaskCompleted(taskId, task.completed));
            leftSection.appendChild(checkbox);

            const taskTextElement = document.createElement('span');
            taskTextElement.textContent = task.text;
            taskTextElement.className = `task-text text-gray-700 text-sm sm:text-base truncate ${task.completed ? 'line-through text-gray-400' : ''}`;
            leftSection.appendChild(taskTextElement);

            const editInput = document.createElement('input'); // GÃ¶rev metni dÃ¼zenleme input'u
            editInput.type = 'text';
            editInput.value = task.text;
            editInput.className = 'edit-input hidden flex-grow p-0.5 border border-indigo-300 rounded-md focus:ring-1 focus:ring-indigo-500 text-sm sm:text-base';
            leftSection.appendChild(editInput);
            topRow.appendChild(leftSection);

            // --- Kebab MenÃ¼ ve DiÄŸer Aksiyon ButonlarÄ± ---
            const taskActions = document.createElement('div');
            taskActions.className = 'task-actions flex items-center space-x-1 sm:space-x-1.5 flex-shrink-0 ml-1';

            if (!task.completed) { // GÃ¶rev tamamlanmamÄ±ÅŸsa dÃ¼zenleme ve Gemini butonlarÄ±nÄ± gÃ¶ster
                const editButton = document.createElement('button');
                editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-4 sm:w-4 text-gray-500 hover:text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>`;
                editButton.className = 'p-1.5 sm:p-1 rounded-md hover:bg-gray-200 edit-action-btn';
                editButton.title = "GÃ¶revi DÃ¼zenle";
                editButton.addEventListener('click', (e) => { // GÃ¶rev dÃ¼zenleme moduna geÃ§
                    e.stopPropagation();
                    taskWrapper.classList.add('editing');
                    topRow.querySelector('.task-text').classList.add('hidden');
                    topRow.querySelector('.edit-input').classList.remove('hidden');
                    topRow.querySelector('.edit-input').focus(); topRow.querySelector('.edit-input').select();
                    taskActions.querySelectorAll('.edit-action-btn, .delete-action, .kebab-menu-container').forEach(btn => btn.classList.add('hidden'));
                    taskWrapper.querySelector('.save-cancel-actions').classList.remove('hidden');
                });
                taskActions.appendChild(editButton);

                // Kebab MenÃ¼
                const kebabMenuContainer = document.createElement('div');
                kebabMenuContainer.className = 'kebab-menu-container';

                const kebabButton = document.createElement('button'); // ÃœÃ§ nokta butonu
                kebabButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-5 sm:w-5 text-gray-500 hover:text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01" /></svg>`;
                kebabButton.className = 'p-1 rounded-full hover:bg-gray-200';
                kebabMenuContainer.appendChild(kebabButton);

                const kebabDropdown = document.createElement('div'); // AÃ§Ä±lÄ±r menÃ¼
                kebabDropdown.className = 'kebab-dropdown hidden'; // BaÅŸlangÄ±Ã§ta gizli

                // DetaylandÄ±r butonu
                const elaborateButton = document.createElement('button');
                elaborateButton.innerHTML = `âœ¨ <span class="ml-2">GÃ¶revi DetaylandÄ±r</span>`;
                elaborateButton.addEventListener('click', (e) => { e.stopPropagation(); elaborateTask(taskId, task.text, elaborateButton, parentListId); kebabDropdown.classList.add('hidden');});
                kebabDropdown.appendChild(elaborateButton);

                // ParÃ§ala butonu
                const breakDownButton = document.createElement('button');
                breakDownButton.innerHTML = `â†ªï¸ <span class="ml-2">GÃ¶revi ParÃ§ala</span>`;
                breakDownButton.addEventListener('click', (e) => { e.stopPropagation(); breakDownTaskIntoSubtasks(taskId, task.text, breakDownButton, parentListId); kebabDropdown.classList.add('hidden');});
                kebabDropdown.appendChild(breakDownButton);

                if (task.parentId) { // Alt gÃ¶revse "Ana GÃ¶rev Yap" butonu ekle
                    const promoteButton = document.createElement('button');
                    promoteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4" /></svg> <span class="ml-2">Ana GÃ¶rev Yap</span>`;
                    promoteButton.addEventListener('click', (e) => { e.stopPropagation(); promoteTaskToMain(taskId); kebabDropdown.classList.add('hidden');});
                    kebabDropdown.appendChild(promoteButton);
                }

                kebabMenuContainer.appendChild(kebabDropdown);
                taskActions.appendChild(kebabMenuContainer);

                // Kebab menÃ¼yÃ¼ aÃ§/kapat
                kebabButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // DiÄŸer aÃ§Ä±k kebab menÃ¼lerini kapat
                    document.querySelectorAll('.kebab-dropdown:not(.hidden)').forEach(openDropdown => {
                        if (openDropdown !== kebabDropdown) {
                            openDropdown.classList.add('hidden');
                        }
                    });
                    kebabDropdown.classList.toggle('hidden');
                });
            }

            const deleteButton = document.createElement('button'); // Her zaman gÃ¶rÃ¼nen silme butonu
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 sm:h-4 sm:w-4 text-red-400 hover:text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
            deleteButton.className = 'delete-action p-1.5 sm:p-1 rounded-full hover:bg-red-100';
            deleteButton.addEventListener('click', (e) => { e.stopPropagation(); deleteTask(taskId); });
            taskActions.appendChild(deleteButton);
            topRow.appendChild(taskActions);

            // DÃ¼zenleme modundayken gÃ¶rÃ¼necek Kaydet/Ä°ptal butonlarÄ±
            const saveCancelActions = document.createElement('div');
            saveCancelActions.className = 'save-cancel-actions hidden flex items-center space-x-1.5 mt-1 self-end mr-1';
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Kaydet';
            saveButton.className = 'bg-green-500 hover:bg-green-600 text-white py-0.5 px-2 rounded text-xs';
            saveButton.addEventListener('click', async (e) => { 
                e.stopPropagation();
                const newText = topRow.querySelector('.edit-input').value;
                await updateTaskText(taskId, newText);
                topRow.querySelector('.task-text').textContent = newText;
                taskWrapper.classList.remove('editing'); 
                topRow.querySelector('.task-text').classList.remove('hidden');
                topRow.querySelector('.edit-input').classList.add('hidden');
                // ButonlarÄ± tekrar gÃ¶rÃ¼nÃ¼r yap
                taskActions.querySelectorAll('.kebab-menu-container, .delete-action, .edit-action-btn').forEach(btn => btn.classList.remove('hidden'));
                taskWrapper.querySelector('.save-cancel-actions').classList.add('hidden');
            });
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Ä°ptal';
            cancelButton.className = 'bg-gray-300 hover:bg-gray-400 text-gray-700 py-0.5 px-2 rounded text-xs';
            cancelButton.addEventListener('click', (e) => { 
                e.stopPropagation();
                topRow.querySelector('.edit-input').value = topRow.querySelector('.task-text').textContent; // Input'u eski haline getir
                taskWrapper.classList.remove('editing'); 
                topRow.querySelector('.task-text').classList.remove('hidden');
                topRow.querySelector('.edit-input').classList.add('hidden');
                taskActions.querySelectorAll('.kebab-menu-container, .delete-action, .edit-action-btn').forEach(btn => btn.classList.remove('hidden'));
                taskWrapper.querySelector('.save-cancel-actions').classList.add('hidden');
            });
            saveCancelActions.appendChild(saveButton);
            saveCancelActions.appendChild(cancelButton);
            
            taskWrapper.appendChild(topRow);
            taskWrapper.appendChild(saveCancelActions);
            
            targetElement.appendChild(listItem); // GÃ¶revi hedef elemente (ul) ekle

            // GÃ¶rev Ã§Ã¶kertilmemiÅŸse ve alt gÃ¶revleri varsa onlarÄ± da render et
            if (!taskDoc.isCollapsed && children.length > 0) {
                const subTaskList = document.createElement('ul');
                subTaskList.className = 'subtask-list'; 
                listItem.appendChild(subTaskList); 
                children.sort((a,b)=> a.data.order - b.data.order); // Alt gÃ¶revleri sÄ±rala
                children.forEach((childDoc) => { 
                    renderTaskNode(childDoc, level + 1, childrenMap, subTaskList); // Ã–zyinelemeli Ã§aÄŸrÄ±
                });
            }
        }
        
        // Ana uygulama UI'Ä±nÄ± render eder (listeler ve gÃ¶revler)
        function renderAppUI() {
            if (!userId) { // KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸsa auth ekranÄ±nÄ± gÃ¶ster
                if (authContainer) authContainer.classList.remove('hidden');
                if (appMainContainer) appMainContainer.classList.add('hidden');
                return;
            }

            // KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸsa ana uygulama ekranÄ±nÄ± gÃ¶ster
            if (authContainer) authContainer.classList.add('hidden');
            if (appMainContainer) appMainContainer.classList.remove('hidden');
            
            renderListsUI(); // Sol paneli render et
            
            // Aktif liste yoksa ve listeler varsa ilkini aktif yap
            if (!activeListId && localListsCache.length > 0) {
                 const sortedLists = [...localListsCache].sort((a, b) => (a.data.order || 0) - (b.data.order || 0));
                 activeListId = sortedLists[0].id; 
                if (listSelectorForNewTask && listSelectorForNewTask.options.length > 0) {
                     listSelectorForNewTask.value = activeListId; // Yeni gÃ¶rev ekleme select'ini gÃ¼ncelle
                }
            } else if (localListsCache.length === 0 && userId) { // HiÃ§ liste yoksa gÃ¶rev panelini gizle
                if(globalNoListsMessage) globalNoListsMessage.classList.remove('hidden');
                if(tasksPanel) tasksPanel.classList.add('hidden'); 
                if(activeListNameHeader) activeListNameHeader.textContent = "Liste Yok";
                if(activeTaskList) activeTaskList.innerHTML = '';
                if (listSelectorForNewTask) listSelectorForNewTask.innerHTML = '<option value="">Liste Yok</option>';
                if(taskInput) taskInput.disabled = true;
                if(addTaskButton) addTaskButton.disabled = true;
                return;
            }
            if(tasksPanel && userId) tasksPanel.classList.remove('hidden'); 

            const activeList = localListsCache.find(l => l.id === activeListId);
            if (activeListNameHeader) { // Aktif liste baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
                activeListNameHeader.textContent = activeList ? activeList.data.name : "Bir Liste SeÃ§in";
                activeListNameHeader.className = `text-2xl font-semibold mb-3 pb-1 border-b-2 ${activeListId === defaultListTodayId ? 'text-emerald-700 border-emerald-500' : (activeListId === defaultListLaterId ? 'text-sky-700 border-sky-500' : 'text-gray-700 border-gray-400')}`;
            }
            
            if(activeTaskList) activeTaskList.innerHTML = ''; // Ã–nceki gÃ¶revleri temizle
            if(noTasksInListMessage) noTasksInListMessage.classList.add('hidden'); // "GÃ¶rev yok" mesajÄ±nÄ± gizle

            if (!activeListId && userId) { // Aktif liste seÃ§ilmemiÅŸse mesaj gÃ¶ster
                if(noTasksInListMessage) {
                     noTasksInListMessage.textContent = "LÃ¼tfen Ã§alÄ±ÅŸmak iÃ§in bir liste seÃ§in.";
                     noTasksInListMessage.classList.remove('hidden');
                }
                return;
            }

            // Aktif listedeki gÃ¶revleri ve alt gÃ¶revleri haritala
            const childrenMap = new Map(); // { parentId: [childTaskDoc, ...] }
            const topLevelTasksInActiveList = []; // Sadece ana gÃ¶revler

            // Firestore'dan gelen tÃ¼m gÃ¶revleri (Ã¶nbellekteki) filtrele
            const allTasks = localTasksCache.filter(item => item.data && item.data.hasOwnProperty('listId')); 

            allTasks.forEach(taskDoc => { 
                if (taskDoc.data.listId === activeListId) { // Sadece aktif listedeki gÃ¶revler
                    const parentId = taskDoc.data.parentId;
                    if (parentId) { // Alt gÃ¶revse childrenMap'e ekle
                        if (!childrenMap.has(parentId)) childrenMap.set(parentId, []);
                        childrenMap.get(parentId).push(taskDoc);
                    } else { // Ana gÃ¶revse topLevelTasksInActiveList'e ekle
                        topLevelTasksInActiveList.push(taskDoc);
                    }
                }
            });
            
            topLevelTasksInActiveList.sort((a,b) => (a.data.order || 0) - (b.data.order || 0)); // Ana gÃ¶revleri sÄ±rala

            if (topLevelTasksInActiveList.length === 0 && childrenMap.size === 0 && userId) { // HiÃ§ gÃ¶rev yoksa mesaj gÃ¶ster
                if(noTasksInListMessage) {
                     noTasksInListMessage.textContent = `Bu listede (${activeList?.data.name || ''}) henÃ¼z gÃ¶rev yok.`;
                     noTasksInListMessage.classList.remove('hidden');
                }
            } else if (userId) { // GÃ¶revler varsa render et
                topLevelTasksInActiveList.forEach((taskDoc) => renderTaskNode(taskDoc, 0, childrenMap, activeTaskList));
            }
        }


        // --- Firebase Dinleyicileri ---
        // KullanÄ±cÄ±ya Ã¶zel verileri (listeler ve gÃ¶revler) dinler
        function listenToUserSpecificData() {
            if (!userId || !db) return;
            
            if(loadingIndicator) loadingIndicator.classList.remove('hidden'); // YÃ¼kleme gÃ¶stergesini gÃ¶ster

            // Listeleri dinle
            if (unsubscribeLists) unsubscribeLists(); // Ã–nceki dinleyiciyi kaldÄ±r
            listsCollectionRef = collection(db, "artifacts", appId, "users", userId, "lists");
            const qLists = query(listsCollectionRef, orderBy("order", "asc")); // Listeleri sÄ±ralÄ± al
            unsubscribeLists = onSnapshot(qLists, async (querySnapshot) => {
                const newLists = [];
                querySnapshot.forEach((doc) => {
                    newLists.push({ id: doc.id, data: doc.data() });
                });
                localListsCache = newLists; // Yerel Ã¶nbelleÄŸi gÃ¼ncelle
                console.log("Lists updated from Firestore:", localListsCache.length);
                await ensureDefaultListsExist(); // VarsayÄ±lan listeleri kontrol et/oluÅŸtur
                renderAppUI(); // UI'Ä± yeniden render et
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Listeleri dinlerken hata:", error);
                showAppErrorModal("Listeler alÄ±nÄ±rken bir sorun oluÅŸtu.");
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
            });

            // GÃ¶revleri dinle
            if (unsubscribeTodos) unsubscribeTodos(); // Ã–nceki dinleyiciyi kaldÄ±r
            todosCollectionRef = collection(db, "artifacts", appId, "users", userId, "todos");
            // orderBy("createdAt", "desc") veya "order" kullanÄ±labilir. 
            // "order" anlÄ±k gÃ¼ncellemelerde daha tutarlÄ± olabilir. Åimdilik createdAt kalsÄ±n.
            const qTodos = query(todosCollectionRef, orderBy("createdAt", "desc")); 
            unsubscribeTodos = onSnapshot(qTodos, (querySnapshot) => {
                const newTasks = [];
                querySnapshot.forEach((doc) => { 
                    // Ã‡Ã¶kertme durumunu korumak iÃ§in Ã¶nceki Ã¶nbellekten al
                    const existingTaskData = localTasksCache.find(lt => lt.id === doc.id && lt.data.hasOwnProperty('listId'));
                    newTasks.push({ 
                        id: doc.id, 
                        data: doc.data(),
                        isCollapsed: existingTaskData ? existingTaskData.isCollapsed : false 
                    }); 
                });
                localTasksCache = newTasks; // Yerel gÃ¶rev Ã¶nbelleÄŸini gÃ¼ncelle
                renderAppUI(); 
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Firestore todos listen error:", error); 
                showAppErrorModal(`GÃ¶revler alÄ±nÄ±rken hata: ${error.message}.`);
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
            });
        }


        // --- Kimlik Durumu DeÄŸiÅŸikliÄŸi Dinleyicisi ---
        if(authInstance) { 
            onAuthStateChanged(authInstance, async (user) => { 
                clearAuthError(); 
                if (user) { // KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸsa
                    userId = user.uid;
                    if (user.isAnonymous) {
                        if(authStatusDisplay) authStatusDisplay.textContent = 'Anonim KullanÄ±cÄ±';
                        if(userIdDisplayElement) userIdDisplayElement.textContent = `GeÃ§ici ID: ${userId.substring(0,10)}...`;
                    } else {
                        if(authStatusDisplay) authStatusDisplay.textContent = `GiriÅŸ YapÄ±ldÄ±: ${user.email}`;
                        if(userIdDisplayElement) userIdDisplayElement.textContent = `KullanÄ±cÄ± ID: ${userId.substring(0,10)}...`;
                    }
                    // UI elementlerini gÃ¼ncelle
                    if(authStatusDisplay) authStatusDisplay.classList.remove('hidden');
                    if(userIdDisplayElement) userIdDisplayElement.classList.remove('hidden');
                    if(logoutButton) logoutButton.classList.remove('hidden');
                    if(manageApiKeyButton) manageApiKeyButton.classList.remove('hidden'); 
                    
                    if(authContainer) authContainer.classList.add('hidden');
                    if(appMainContainer) appMainContainer.classList.remove('hidden'); 
                    
                    if (db) { // Firestore baÅŸlatÄ±lmÄ±ÅŸsa
                        await checkAndPromptForGeminiApiKey(); // API anahtarÄ±nÄ± kontrol et
                        listenToUserSpecificData(); // Verileri dinlemeye baÅŸla
                    } else {
                         console.error("DB (Firestore) is not initialized!");
                         showAppErrorModal("VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±.");
                    }
                } else { // KullanÄ±cÄ± Ã§Ä±kÄ±ÅŸ yapmÄ±ÅŸsa veya hiÃ§ giriÅŸ yapmamÄ±ÅŸsa
                    userId = null;
                    activeListId = null; 
                    defaultListTodayId = null;
                    defaultListLaterId = null;
                    localListsCache = []; 
                    localTasksCache = []; 
                    userProvidedGeminiApiKey = null; 

                    // UI elementlerini sÄ±fÄ±rla
                    if(authStatusDisplay) authStatusDisplay.textContent = 'Oturum KapalÄ±';
                    if(authStatusDisplay) authStatusDisplay.classList.add('hidden'); 
                    if(userIdDisplayElement) userIdDisplayElement.classList.add('hidden');
                    if(logoutButton) logoutButton.classList.add('hidden');
                    if(manageApiKeyButton) manageApiKeyButton.classList.add('hidden'); 

                    if (unsubscribeTodos) unsubscribeTodos(); // Dinleyicileri kaldÄ±r
                    if (unsubscribeLists) unsubscribeLists();
                    
                    renderAppUI(); // UI'Ä± auth ekranÄ±na dÃ¶ndÃ¼r
                    
                    if(authContainer) authContainer.classList.remove('hidden');
                    if(appMainContainer) appMainContainer.classList.add('hidden'); 
                    
                    if(loginForm) loginForm.reset(); // FormlarÄ± temizle
                    if(signupForm) signupForm.reset();

                    // Ortam tarafÄ±ndan saÄŸlanan Ã¶zel token ile giriÅŸ denemesi (Canvas ortamÄ± iÃ§in)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        console.log("Ã–zel token ile giriÅŸ deneniyor (onAuthStateChanged)...");
                        try {
                            if(authInstance) await signInWithCustomToken(authInstance, __initial_auth_token);
                        } catch (error) {
                            console.error("Ã–zel token ile giriÅŸ hatasÄ± (onAuthStateChanged):", error);
                            // BaÅŸarÄ±sÄ±z olursa anonim giriÅŸ yapmayÄ± deneyebiliriz.
                        }
                    } else {
                        console.log("KullanÄ±cÄ± oturumu yok, giriÅŸ bekleniyor.");
                    }
                }
                if(loadingIndicator) loadingIndicator.classList.add('hidden'); 
            });
        } else {
            console.error("Firebase Auth baÅŸlatÄ±lamadÄ±, onAuthStateChanged ayarlanamadÄ±.");
            if(authContainer) authContainer.classList.remove('hidden'); 
            if(appMainContainer) appMainContainer.classList.add('hidden'); 
            if(loadingIndicator) loadingIndicator.classList.add('hidden'); 
        }
        
        // --- Olay Dinleyicileri (Sayfa YÃ¼klendiÄŸinde) ---
        window.addEventListener('load', () => {
            // Auth formlarÄ± arasÄ± geÃ§iÅŸ
            if(switchToSignup) {
                switchToSignup.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    if(loginForm) loginForm.classList.add('hidden'); 
                    if(signupForm) signupForm.classList.remove('hidden'); 
                    clearAuthError(); 
                });
            }
            if(switchToLogin) {
                switchToLogin.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    if(signupForm) signupForm.classList.add('hidden'); 
                    if(loginForm) loginForm.classList.remove('hidden'); 
                    clearAuthError();

                });
            }
            
            // Form gÃ¶nderme iÅŸlemleri
            if(loginForm) loginForm.addEventListener('submit', handleLogin);
            if(signupForm) signupForm.addEventListener('submit', handleSignup);
            
            // Buton tÄ±klama iÅŸlemleri
            if(logoutButton) logoutButton.addEventListener('click', handleLogout);
            if(googleLoginButton) googleLoginButton.addEventListener('click', handleGoogleLogin);
            
            if(addListButton) {
                addListButton.addEventListener('click', function(event) { 
                    console.log('Add List Button - click listener fired.');
                    event.preventDefault(); 
                    handleAddNewList(); 
                }); // addListButton kapanÄ±ÅŸ parantezi
            } // addListButton if bloÄŸu kapanÄ±ÅŸÄ±

            if (addListButton) {
                setTimeout(() => {
                    addListButton.textContent = 'Liste Ekle';
                }, 100);
            }

            if(hamburgerButton) {
                hamburgerButton.addEventListener('click', () => {
                    if(listsPanel) {
                        listsPanel.classList.remove('-translate-x-full');
                        listsPanel.style.zIndex = '1050';
                    }
                    if(sidebarOverlay) {
                        sidebarOverlay.classList.remove('hidden');
                        sidebarOverlay.style.zIndex = '1040';
                    }
                });
            }
            if(sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    if(listsPanel) {
                        listsPanel.classList.add('-translate-x-full');
                    }
                    if(sidebarOverlay) {
                        sidebarOverlay.classList.add('hidden');
                    }
                });
            }
            
            // Enter tuÅŸu ile liste ekleme
            if(newListInput) {
                newListInput.addEventListener('keypress', (e) => { 
                    if (e.key === 'Enter') {
                        if (document.activeElement === newListInput) { 
                             console.log('New List Input - Enter keypress listener fired.'); 
                             e.preventDefault(); 
                             handleAddNewList();
                        }
                    }
                });
            }
            
            // GÃ¶rev ekleme
            if(addTaskButton) {
                addTaskButton.addEventListener('click', addTaskFromInput);
            }
            if(taskInput) {
                taskInput.addEventListener('keypress', (event) => { 
                    if (event.key === 'Enter') {
                        if (document.activeElement === taskInput) { 
                            addTaskFromInput();
                        }
                    }
                });
            }

            // Gemini API ModalÄ± butonlarÄ±
            if(saveGeminiApiKeyButton) {
                saveGeminiApiKeyButton.addEventListener('click', saveUserGeminiApiKey);
            }
            if(closeGeminiApiKeyModalButton) {
                closeGeminiApiKeyModalButton.addEventListener('click', () => {
                    if(geminiApiKeyModal) geminiApiKeyModal.classList.add('hidden');
                });
            }
            if(manageApiKeyButton) {
                manageApiKeyButton.addEventListener('click', () => {
                     if(geminiApiKeyModal) geminiApiKeyModal.classList.remove('hidden');
                     if(geminiApiKeyInput && userProvidedGeminiApiKey) {
                        geminiApiKeyInput.value = userProvidedGeminiApiKey;
                     } else if (geminiApiKeyInput) {
                        geminiApiKeyInput.value = ''; 
                     }
                });
            }

            // Kebab menÃ¼leri dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda kapatma (genel)
            document.addEventListener('click', (e) => {
                const openKebabDropdowns = document.querySelectorAll('.kebab-dropdown:not(.hidden)');
                openKebabDropdowns.forEach(dropdown => {
                    const container = dropdown.closest('.kebab-menu-container');
                    if (container && !container.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
            });

        }); // window.addEventListener('load') kapanÄ±ÅŸÄ±

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f9fafb; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        /* Liste dÃ¼zenleme modundayken bazÄ± elemanlarÄ± gizle */
         .list-item.editing-list .list-name-span, 
        .list-item.editing-list .edit-list-btn,
        .list-item.editing-list .delete-list-btn {
            display: none;
        } /* Bu sÃ¼slÃ¼ parantez Ã¶nceki hatada eksikti, eklendi */
        /* Kebab MenÃ¼ Stilleri */
        .kebab-menu-container { position: relative; }
        .kebab-dropdown {
            position: absolute;
            right: 0;
            top: 100%; /* Butonun hemen altÄ±nda */
            margin-top: 8px; /* Butonla arasÄ±nda kÃ¼Ã§Ã¼k bir boÅŸluk */
            z-index: 10; /* DiÄŸer elemanlarÄ±n Ã¼zerinde */
            border-radius: 0.5rem; /* Yuvarlak kÃ¶ÅŸeler */
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* GÃ¶lge */
            border: 1px solid #e5e7eb; /* KenarlÄ±k */
            width: 180px; /* MenÃ¼ geniÅŸliÄŸi */
            overflow: hidden; /* Butonlar taÅŸarsa gizle (gÃ¼venlik) */
        }
        .kebab-dropdown button {
            display: flex;
            align-items: center; /* Ä°kon ve metni hizala */
            width: 100%;
            padding: 8px 12px;
            font-size: 0.875rem; /* 14px */
            color: #374151; /* text-gray-700 */
            text-align: left;
        }
        .kebab-dropdown button:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-2 sm:p-4 bg-gradient-to-tr from-slate-300 via-gray-300 to-stone-400">

    <!-- Mobil menÃ¼ aÃ§Ä±ldÄ±ÄŸÄ±nda arkaplanÄ± kaplayan overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40 md:hidden"></div>

    <!-- Ana Uygulama Konteyneri (GiriÅŸ yapÄ±ldÄ±ktan sonra gÃ¶rÃ¼nÃ¼r) -->
    <div id="appMainContainer" class="bg-white/95 backdrop-blur-xl shadow-2xl rounded-2xl p-4 md:p-6 lg:p-8 w-full max-w-3xl lg:max-w-4xl flex flex-col md:flex-row gap-6 hidden">
        
        <!-- Sol Panel: Listeler ve Auth Bilgileri -->
        <aside id="listsPanel" class="w-80 md:w-1/3 lg:w-1/4 space-y-6 flex flex-col 
                                     fixed top-0 left-0 h-full bg-white/95 backdrop-blur-xl p-4 
                                     transform -translate-x-full md:relative md:translate-x-0 
                                     md:bg-transparent md:backdrop-blur-none 
                                     md:border-r md:pr-6 md:p-0">
            <header class="text-center md:text-left">
                <h1 class="text-2xl sm:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-slate-700 via-gray-600 to-stone-700">
                    YapÄ±lacaklar Listesi
                </h1>
                <div id="authStatusContainer" class="mt-1 text-xs text-gray-600">
                    <span id="authStatus" class="hidden">Oturum durumu...</span>
                    <span id="userIdDisplay" class="ml-1 text-gray-500 hidden tracking-tight"></span>
                    <button id="logoutButton" class="ml-2 hidden text-red-500 hover:text-red-700 font-semibold text-xs underline">Ã‡Ä±kÄ±ÅŸ Yap</button>
                </div>
                 <button id="manageApiKeyButton" class="mt-2 hidden text-xs text-blue-600 hover:text-blue-800 underline">Gemini API AnahtarÄ±nÄ± YÃ¶net</button>
            </header>
            
            <div class="flex-grow">
                <h3 class="text-md font-semibold text-gray-500 mb-2">LÄ°STELERÄ°M</h3>
                <div id="listsContainer" class="space-y-1 max-h-48 md:max-h-64 overflow-y-auto mb-3 pr-1">
                    <!-- Listeler JavaScript ile buraya render edilecek -->
                </div>
                <p id="globalNoListsMessage" class="text-gray-400 text-sm text-center py-3 hidden">Liste oluÅŸturarak baÅŸlayÄ±n.</p>
                <div class="mt-3 space-y-2">
                    <div>
                        <label for="newListInput" class="sr-only">Yeni liste adÄ±</label>
                        <input type="text" id="newListInput" placeholder="Yeni liste adÄ±..." class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                    </div>
                </div>
            </div>
        </aside>

        <!-- SaÄŸ Panel: Aktif Liste ve GÃ¶revler -->
        <main id="tasksPanel" class="w-full md:w-2/3 lg:w-3/4"> 
             <div id="taskInputArea" class="mb-4 flex flex-col sm:flex-row gap-2">
                <input type="text" id="taskInput" placeholder="Yeni gÃ¶rev ekle..." class="flex-grow p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-3 focus:ring-cyan-400 focus:border-cyan-400 text-sm">
                <div class="flex gap-2"> <!-- Select ve Buton mobil'de yan yana kalsÄ±n diye -->
                    <select id="listSelectorForNewTask" class="flex-grow p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-sm bg-white appearance-none"></select>
                    <button id="addTaskButton" class="bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                    Ekle
                    </button>
                </div>
            </div>

            <div id="loadingIndicator" class="hidden flex justify-center items-center my-5">
                <div class="animate-spin-slow rounded-full h-10 w-10 border-t-4 border-b-4 border-cyan-500"></div>
                <p class="ml-3 text-gray-700">YÃ¼kleniyor...</p>
            </div>
            
            <div id="mainContentArea" class="space-y-4 max-h-[65vh] overflow-y-auto p-1">
                <!-- BaÅŸlÄ±k ve Mobil MenÃ¼ Butonu -->
                <div class="flex items-center mb-2 md:mb-3">
                    <button id="hamburgerButton" class="p-2 mr-2 rounded-md hover:bg-gray-200 md:hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                        </svg>
                    </button>
                    <h2 id="activeListNameHeader" class="text-2xl font-semibold pb-1 border-b-2">
                        Liste YÃ¼kleniyor...
                    </h2>
                </div>
                <ul id="activeTaskList" class="space-y-1">
                    <!-- GÃ¶revler JavaScript ile buraya render edilecek -->
                </ul>
                <p id="noTasksInListMessage" class="text-gray-500 text-center py-4 hidden"></p>
            </div>
        </main>

    </div> <!-- appMainContainer kapanÄ±ÅŸÄ± -->
    
    <!-- Kimlik DoÄŸrulama Konteyneri (BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nÃ¼r) -->
    <div id="authContainer" class="bg-white/95 backdrop-blur-xl shadow-2xl rounded-2xl p-4 md:p-6 lg:p-8 w-full max-w-md mx-auto">
        <header class="mb-6 text-center">
             <h1 class="text-2xl sm:text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-slate-700 via-gray-600 to-stone-700">
                YapÄ±lacaklar Listesi
            </h1>
        </header>
        <div id="authErrorMessages" class="mb-4 p-3 bg-red-100 text-red-700 rounded-md text-sm hidden"></div>
        <!-- GiriÅŸ Formu -->
        <form id="loginForm" class="space-y-3">
            <h2 class="text-lg font-semibold text-gray-700">GiriÅŸ Yap</h2>
            <div>
                <label for="loginEmail" class="sr-only">E-posta</label>
                <input type="email" id="loginEmail" placeholder="E-posta" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
            </div>
            <div>
                <label for="loginPassword" class="sr-only">Åifre</label>
                <input type="password" id="loginPassword" placeholder="Åifre" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
            </div>
            <button id="loginButton" type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-cyan-600 hover:bg-cyan-700">GiriÅŸ Yap</button>
            <button type="button" id="googleLoginButton" class="mt-2 w-full flex justify-center items-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                 <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.223,0-9.657-3.356-11.303-8H6.306C9.656,39.663,16.318,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l0.001-0.001l6.19,5.238C39.903,38.635,44,31.886,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                Google ile GiriÅŸ Yap
            </button>
            <p class="text-xs text-center">
                HesabÄ±nÄ±z yok mu? <a href="#" id="switchToSignup" class="font-medium text-cyan-600 hover:text-cyan-500">Kaydolun</a>
            </p>
        </form>
        <!-- KayÄ±t Formu -->
        <form id="signupForm" class="space-y-3 hidden">
            <h2 class="text-lg font-semibold text-gray-700">Kaydol</h2>
            <div>
                <label for="signupEmail" class="sr-only">E-posta</label>
                <input type="email" id="signupEmail" placeholder="E-posta" required class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
            </div>
            <div>
                <label for="signupPassword" class="sr-only">Åifre</label>
                <input type="password" id="signupPassword" placeholder="Åifre (en az 6 karakter)" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
            </div>
            <button id="signupButton" type="submit" class="w-full flex justify-center py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700">Kaydol</button>
            <p class="text-xs text-center">
                Zaten hesabÄ±nÄ±z var mÄ±? <a href="#" id="switchToLogin" class="font-medium text-cyan-600 hover:text-cyan-500">GiriÅŸ yapÄ±n</a>
            </p>
        </form>
    </div>

    <!-- Gemini API AnahtarÄ± GiriÅŸ ModalÄ± -->
    <div id="geminiApiKeyModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="relative mx-auto p-6 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-xl leading-6 font-bold text-gray-900">Gemini API AnahtarÄ± Gerekli</h3>
                <div class="mt-4 px-7 py-3">
                    <p class="text-sm text-gray-600 mb-3">
                        "ParÃ§ala" ve "DetaylandÄ±r" gibi akÄ±llÄ± Ã¶zellikleri kullanabilmek iÃ§in lÃ¼tfen Google AI Studio'dan aldÄ±ÄŸÄ±nÄ±z Gemini API anahtarÄ±nÄ±zÄ± girin.
                    </p>
                    <input type="text" id="geminiApiKeyInput" placeholder="Gemini API AnahtarÄ±nÄ±z" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                <div class="items-center px-4 py-3 space-x-2 flex justify-end">
                    <button id="closeGeminiApiKeyModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        Kapat
                    </button>
                    <button id="saveGeminiApiKeyButton" class="px-4 py-2 bg-cyan-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-cyan-700 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Genel Hata ModalÄ± -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="relative mx-auto p-5 border-2 border-red-300 w-full max-w-md shadow-2xl rounded-xl bg-white">
            <div class="mt-2 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 sm:h-14 sm:w-14 rounded-full bg-red-100 mb-3">
                    <svg class="h-8 w-8 sm:h-9 sm:w-9 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-xl sm:text-2xl leading-6 font-bold text-gray-900">Hata OluÅŸtu!</h3>
                <div class="mt-3 px-5 py-2"><p id="errorMessage" class="text-sm sm:text-base text-gray-700"></p></div>
                <div class="items-center px-4 py-3 mt-1">
                    <button id="closeErrorModalButton" class="px-5 py-2.5 bg-red-600 text-white text-base sm:text-lg font-semibold rounded-lg w-full shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transition-colors">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini YÃ¼kleme ModalÄ± -->
    <div id="geminiLoadingModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center hidden z-50 p-4">
        <div class="relative mx-auto p-6 w-full max-w-xs sm:max-w-sm shadow-xl rounded-lg bg-white text-center">
            <div class="animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-t-4 border-b-4 border-purple-500 mx-auto mb-3"></div>
            <p id="geminiLoadingModalTitle" class="text-base sm:text-lg font-medium text-gray-700">âœ¨ Gemini dÃ¼ÅŸÃ¼nÃ¼yor...</p>
            <p id="geminiLoadingModalDescription" class="text-xs sm:text-sm text-gray-500 mt-1">Ä°ÅŸleniyor...</p>
        </div>
    </div>

    <footer class="mt-8 text-center">
        <p class="text-xs sm:text-sm text-white opacity-80">YapÄ±lacaklar Listesi &copy; 2024</p>
    </footer>

</body>
</html>
